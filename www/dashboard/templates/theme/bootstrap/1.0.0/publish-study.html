<!-- Study Publish Template
    Variables:
        study: survana.Study
        study_forms: an array of this study's form json
        current_form: index pointing to the currently visible form in the study.
-->
<!DOCTYPE html>
<html>
    <head>
        <title>{{ study.title }}</title>
        <meta name="viewport" content="width=device-width">
        <link rel="stylesheet" type="text/css" href="assets/lib/survana/1.0.0/theme/bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" type="text/css" href="assets/lib/survana/1.0.0/theme/bootstrap/css/bootstrap-theme.min.css">
        <link rel="stylesheet" type="text/css" href="assets/lib/survana/1.0.0/theme/bootstrap/css/matrix.css">
        <link rel="stylesheet" type="text/css" href="assets/lib/survana/1.0.0/theme/bootstrap/css/progress.css">
        <link rel="stylesheet" type="text/css" href="assets/lib/survana/1.0.0/theme/bootstrap/css/validation.css">
        <style type="text/css">
            question blockquote {
                color: #3a3a3a;
                border-left-color: #3a3a3a;
            }
        </style>
    </head>
    <body style="overflow-y: scroll;" data-storage-scope="{{ study.id }}">
        <!-- header -->
        <div class="navbar navbar-default navbar-static-top">
            <div class="container">
                <div class="progress progress-striped s-progress pull-left">
                    <div class="progress-bar progress-bar-info" style="width: {{ (((current.index - 0) + 1) / study_forms.length)*100}}%"></div>
                    <div class="progress-text">
                        <span class="glyphicon glyphicon-check" style="color:white"></span>
                        <span>{{ (current.index - 0) + 1 }} of {{ study_forms.length }}</span>
                    </div>
                </div>
                <button id="btnNext" ng-class="{'hidden':current.index==(study_forms.length-1)}" class="btn btn-danger navbar-btn pull-right" onclick="Survana.Workflow.NextPage(this)">Next <span class="glyphicon glyphicon-circle-arrow-right"></span></button>
                <button id="btnFinish" ng-class="{'hidden':current.index<(study_forms.length-1)}" class="btn btn-success navbar-btn pull-right" onclick="Survana.Workflow.NextPage(this)">Finish <span class="glyphicon glyphicon-circle-arrow-right"></span></button>
            </div>
        </div>

        <div id="content" class="container" style="margin-top:25px;"></div>

        <!-- form schemata -->
        <script id="schemata" type="text/schemata"></script>

        <!-- validation configuration -->
        <script id="validation" type="text/validation"></script>

        <!-- scripts must in the <body>, otherwise they cause the frame document to delay DOM parsing -->
        <script type="text/javascript" src="assets/lib/survana/1.0.0/theme/bootstrap/js/jquery.min.js"></script>
        <script type="text/javascript" src="assets/lib/survana/1.0.0/theme/bootstrap/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="assets/lib/survana/1.0.0/theme/bootstrap/js/validation.js"></script>

        <script type="text/javascript" src="assets/lib/survana/1.0.0/survana.js"></script>
        <script type="text/javascript" src="assets/lib/survana/1.0.0/survana-storage.js"></script>
        <script type="text/javascript" src="assets/lib/survana/1.0.0/survana-request.js"></script>
        <script type="text/javascript" src="assets/lib/survana/1.0.0/survana-queue.js"></script>
        <script type="text/javascript" src="assets/lib/survana/1.0.0/survana-workflow.js"></script>
        <script type="text/javascript" src="assets/lib/survana/1.0.0/survana-validation.js"></script>


        <script type="text/javascript">
            function readSchemata(form) {
                if (!form || Survana === undefined) {
                    return;
                }

                var el = document.getElementById('schemata');

                if (!el || !el.innerHTML || !form.id) {
                    return;
                }

                try {
                    Survana.Schema[form.id] = JSON.parse(el.innerHTML);
                    console.log('form', form.id, ' schemata', Survana.Schema[form.id]);
                } catch (e) {
                    console.error("Invalid Form Schemata:", el.innerHTML, e);
                }
            }

            window.startValidation = function (form) {
                if (!form || Survana === undefined) {
                    return;
                }

                var validation_el = document.getElementById('validation'),
                        validation_config;

                if (!validation_el.innerHTML) {
                    return;
                }

                try {
                    validation_config = JSON.parse(validation_el.innerHTML);
                    console.log('validation config:', validation_el.innerHTML);
                } catch (e) {
                    console.error('Invalid Validation configuration:', validation_el.innerHTML);
                }

                //register validation configuration
                Survana.Validation.SetConfiguration(form, validation_config);
            };

            window.validateForm = function () {
                if (document.forms && document.forms[0] && Survana !== undefined) {
                    var form_id = document.forms[0].id;
                    Survana.Validation.Validate(document.forms[0], Survana.Schema[form_id]);
                }
            };

            readSchemata(document.forms[0]);
            window.startValidation(document.forms[0]);

            //hide buttons if the survey has been completed and the user tries to go back to the previous forms
            Survana.Storage.Get('completed', function (value) {
                if (value) {
                    var btnNext = document.getElementById('btnNext'),
                        btnFinish = document.getElementById('btnFinish');

                    if (btnNext) {
                        btnNext.style.visibility = 'hidden';
                    }

                    if (btnFinish) {
                        btnFinish.style.visibility = 'hidden';
                    }
                }
            })
        </script>
    </body>
</html>

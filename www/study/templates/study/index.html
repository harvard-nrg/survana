<!DOCTYPE html>
<html>
<head>
    <title><% .Title %></title>
    <style type="text/css">
        .hidden {
            display: none;
        }
    </style>
    <script type="text/javascript" src="assets/lib/survana/1.0.0/survana-storage.js"></script>
</head>
<body>
    <div id="message" class="hidden"></div>
    <script type="text/javascript">

        var study_id = '<%js .Id %>',
            workflow = [
                <%range $i, $form := .Forms %>
                "form?s=" + study_id + "&f=<%js $i %>",
                <%end%>
            ];

        startStudy(study_id, workflow);

        function onStorageError(e) {
            console.error(e);
        }

        function startStudy(study_id, workflow) {
            var context = {
                current: null,
                workflow: null
            };

            //first run or new window/tab
            if (!sessionStorage['study_id']) {
                //set the current study_id
                sessionStorage['study_id'] = study_id;

                Survana.Storage.SetPrefix(study_id);

                //check for existing sessions in other tabs (attempt to resume)
                Survana.Storage.Get(context, function (result) {
                    context = result;

                    //if we've found a valid session, reuse it
                    if (context.current !== null && context.workflow !== null) {
                        context.current |= 0; //cast to int
                        //nothing to do for the workflow
                    } else {
                        @@@@ FIX THIS BLOCK
                        //start a new session
                        current_form = 0;
                        localStorage[study_id + '-current'] = current_form;
                        localStorage[study_id + '-workflow'] = JSON.stringify(workflow);
                        localStorage[study_id + '-start'] = (new Date()).valueOf();
                    }

                }, onStorageError);

            } else {
                //resume study (if study_id is present, assume all other fields are present too)
                current_form = (localStorage[study_id + '-current']|0) || 0;
            }

            //redirect to the form url
            if (current_form < workflow.length) {
                window.location.href = workflow[current_form];
            } else {
                showMessage('Thank you for completing this survey.');
            }
        }

        function showMessage(msg) {
            var msg_el = document.getElementById('message');

            msg_el.innerHTML = msg;
            msg_el.classList.remove('hidden');
        }
    </script>
</body>
</html>
